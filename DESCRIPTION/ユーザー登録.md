# ユーザー登録 v0.4.3

* ユーザー情報をDBに永続化し、登録されているユーザーを認証する仕組みを作成していきます。
* [Spring-boot-Security](https://docs.spring.io/spring-security/reference/index.html)を利用したユーザー登録を実装する為に次のインターフェースについて学習しよう。
    * [UserDetails](https://docs.spring.io/spring-security/site/docs/5.5.3/api/org/springframework/security/core/userdetails/UserDetails.html) : ユーザー名・パスワード・権限などの情報を保持する
    * [UserDetailsService](https://docs.spring.io/spring-security/site/docs/5.5.3/api/org/springframework/security/core/userdetails/UserDetailsService.html) ：UserDetailsを取得するメソッドを持つ　

* Spring Securityが準備した <<interface>> UserDetailesを継承した CustomUserDetails と <<interface>> UserDetailsServiceを継承したCustomUserDetailsServiceを作成する。

1. src/main/java/com/example/mils/demo/domain/auth/を作成します。
2. authの中に、CustomUserDetailsService クラスを作成してください。
3. CustomUserDetailsServiceはUserDetailsServiceを継承します。
4. UserDetails loadUserByUsernameメソッドをoverrideしたメソッドを作成します。
5. 一旦、UsernameNotFoundException を使って、username を取得されなかった際の例外処理を実行しておきます。

* [UsernameNotFoundException](https://spring.pleiades.io/spring-security/site/docs/current/api/org/springframework/security/core/userdetails/UsernameNotFoundException.html) メソッド
```java
 throw new UsernameNotFoundException(
            "username is not found. username = '" + username + "')"
            );
```
* 続いて、認証方法の実装の設定を WebBasicAuthSecurityConfiguration を実装します。
SecurityConfigクラスに以下のメソッドをオーバーライドしてください。

```java
@Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        //  認証方法の実装の設定を行う　※今回は一旦エラーを吐き出しておく処理を入れておく。
        throw new UsernameNotFoundException(
            "username is not found. username：" + username
            );
    }
```

[AuthenticationManagerBuilder.userDetailsService](https://spring.pleiades.io/spring-security/site/docs/current/api/org/springframework/security/config/annotation/authentication/builders/AuthenticationManagerBuilder.html)

> userDetailsService
public <T extends UserDetailsService> DaoAuthenticationConfigurer<AuthenticationManagerBuilder,​T> userDetailsService​(T userDetailsService) throws java.lang.Exception
渡されたカスタム UserDetailsService に基づいて認証を追加します。次に、DaoAuthenticationConfigurer を返し、認証のカスタマイズを許可します。

>また、このメソッドは、UserDetailsService が getDefaultUserDetailsService() メソッドで使用可能であることを確認します。追加の UserDetailsService がこの UserDetailsService をデフォルトとしてオーバーライドする場合があることに注意してください。

>戻り値:
DAO 認証のカスタマイズを可能にする DaoAuthenticationConfigurer

>例外:
java.lang.Exception - UserDetailsService ベースの認証を追加するときにエラーが発生した場合

* 一旦これで実行をします。その際にブレイクポイントを貼って、実装したプログラムに進んでいるかの確認をします。
    * ![ブレイクポイント](/README-assets/debug-login-exception.png)
    * ![ログイン画面](/README-assets/debug-login-exception-login画面.png)

### CustomUserDetailクラスの実装

[ GrantedAuthority](https://spring.pleiades.io/spring-security/site/docs/current/api/org/springframework/security/core/GrantedAuthority.html)クラス

[User](https://spring.pleiades.io/spring-security/site/docs/current/api/org/springframework/security/core/userdetails/User.html)クラス
このクラスを継承すると、ユーザークラスに関する記述量を抑える事ができる便利なものが色々と用意されている。

```java
public class CustomUserDetails extends User {

    public CustomUserDetails( String username, String password, Collection<? extends GrantedAuthority> authorities ) {
        super(username, password, authorities);
    }
    
}
```
これでusernaem、password,を受け取ります。

では、CustomUserDetailsServiceで仮に受け取る処理を構築して一旦動くようにしておきます。

```java
        if ("user".equals(username)) { //usernameが "user" と同じなら、処理を返す
            return new CustomUserDetails("user", "password", Collections.emptyList()); //Authoritiesは、権限 で現段階では空のリストを返しておく。
        }
```

次にパスワードをハッシュ化するパスワードエンコーダーを実装します。
[ハッシュとは](https://developer.mozilla.org/ja/docs/Glossary/hash)

```java
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService) //コンストラクから渡されたuserDetailServiceをauth.userDetailsServiceに渡している
                .passwordEncoder(NoOpPasswordEncoder.getInstance()); //非推奨のクラスの為、後ほど書き換える。
    }   
```

### ユーザーテーブルの追加 v0.4.4

ユーザーテーブルを追加しましょう。ここでは簡単に username とパスワードだけ管理するテーブルを追加します。

```sql
create table users ( username varchar(128) not null primary key, password varchar(256) not null );
```

これで、SQLの状態をh2-consoleで確認する為に debug用の 記述を追記します。
これは、h2-console以下は様々なセキュリティ要件を無効にしています。
```java
// debug用 - > 後で消す
    http
            .authorizeRequests().antMatchers("/h2-console/**").permitAll()
            .and()
            .csrf().ignoringAntMatchers("/h2-console/**")
            .and()
            .headers().frameOptions().disable();
```

テスト用ユーザーの登録とユーザー管理機能の実装 Data.sqlに追記する
```sql
insert into users (username, password) values ('user', 'password');
insert into users (username, password) values ('user1', 'password');
```

* h2-consoleからuserが登録されていることを確認する。
    * ![Userデータ](/README-assets/h2-console-user.png)

### UserデータをDBへ登録 v0.4.5
* Userクラスを実装して、DBにUser登録を作成する
    以下のフィールドを準備
    * username
    * password

* UserRepositoryクラスを作成
Optionalクラスとは
> Optionalはメソッドの戻り値としてnullを返す可能性があることを明示的に示したいときに使用します。
今回の様にDBのアクセスや外部からのデータを取得する際は、必ず正常な値が入ってこない場合もあります。
nullを扱う判定処理を煩雑に書かなくても良くなるなどのメリットがあります。

```java
    @Select("select * from users where username = #{username}")
    Optional<User> findByUsername(String username);
```

* CustomUserDetailsServiceクラスにuserを呼び出す処理を追加。
userRepositoryを外部インスタンスとして呼び込む為に、loadUserByUsername にDBからuserRepositoryを
通して、Userクラスに取得したusernameとパスワードを返します。

```java
@Service
@RequiredArgsConstructor
public class CustomUserDetailsService implements UserDetailsService {

    private final UserRepository userRepository;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        return userRepository.findByUserName(username)
            .map(
                user -> new CustomUserDetails(
                        user.getUsername(), 
                        user.getPassword(), 
                        Collections.emptyList() //現時点は仮実装
                        )
            )
            .orElseThrow(
                () -> new UsernameNotFoundException(
                    "username is not found :" + username
                )
            );
    }
}
```

## 課題3 以下のUser管理に必要な３画面を実装してください。
* User情報をDBに登録まで実施してください。
* User情報はusernameだけ表示します。
    * User一覧画面
    * User作成画面
