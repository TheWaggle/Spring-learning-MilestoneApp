# ログインの実装

* Spring boot securityを追加しよう。
  Spring-boot-starter-security
  Spring-security-test
  thymeleaf-extras-springsecurity5

maven add dependicyにて追加する。

pom.xmlに追加されていることを確認

```xml
		<dependency>
			<groupId>org.springframework.security</groupId>
			<artifactId>spring-security-test</artifactId>
			<version>5.6.1</version>
		</dependency>


		<dependency>
			<groupId>org.thymeleaf.extras</groupId>
			<artifactId>thymeleaf-extras-springsecurity5</artifactId>
			<version>3.1.0.M1</version>
		</dependency>


		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
			<version>2.6.3</version>
		</dependency>
```

上記を追加して、実行すると、ターミナルに以下のように一時的なパスワードが表示されます。これをパスワード欄に入れてログインします。
ユーザー名は user としてください。

Using generated security password: deb36f12-11e4-4887-8f9d-983ad887c8a1　<- この値は、人それぞれ違います。

![ログイン画面](/README-assets/login.png)

無事にログインを確認できたら、オリジナルのログインページを作成していきます。

1. index.htmlと同じ階層にlogin.htmlを作成します。中身は、とりあえず、index.htmlのコピーに追記して仮のログインページとしておいてください。
2. 続いて、IndexController.javaにlogin.htmlのルート処理をGetMapping("/login")で追加します。
3. 次に demo/src/main/java/com/example/mils/demo/config フォルダを作成します。
    configパッケージには、アプリケーションの設定に関するクラスをパッケージします。
4. configパッケージ内に SecurityConfigクラス を作成します。

SecurityConfiクラスには以下のほぼ提携文見たいなものを入れてください。
```java
@EnableWebSecurity //セキュリティ関連を示すアノテーション
public class SecurityConfig extends WebSecurityConfigurerAdapter{
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
            .mvcMatchers("/login**").permitAll()
            .anyRequest().authenticated()
            .and()
            .formLogin()
            .loginPage("/login");
    }
```

これで、トップページにアクセスし、先ほど作ったログインページへ遷移すれば成功です。


## ユーザーフォーム実装 v0.4.1

id: userName, id: password, でそれぞれformを作成します。
```html
<form>
    <div class="mt-3">
        <label for="userName" class="form-label">ユーザー名</label>
        <input type="text" id="userName" class="form-control">
    </div>
    <div class="mt-3">
        <label for="password" class="form-label">パスワード</label>
        <input type="password" id="password" class="form-control">
    </div>
    <div class="mt-3">
        <button type="submit" class="btn btn-primary">ログイン</button>
    </div>
</form>
```

* SecurityConfig.javaの設定の変更
```java
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
            .mvcMatchers("/login**").permitAll()
            .anyRequest().authenticated()
            .and()
            .formLogin()
            .usernameParameter("userName")   // defultは username -> formのname属性でkeyとして取り扱う変数名を変更する場合につける
            .passwordParameter("passwordKey")// defultは password -> formのname属性でkeyとして取り扱う変数名を変更する場合につける
            .loginPage("/login");
    }
```

* 以下は、SecurityConfig.javaの設定の変更 をした場合
```html
<h1>ログインページ</h1>
<form action="" th:action="@{/login}" method="post">
    <div class="mt-3">
        <label for="userName" class="form-label">ユーザー名</label>
        <input type="text" id="userName" name="userName" class="form-control">
    </div>
    <div class="mt-3">
        <label for="password" class="form-label">パスワード</label>
        <input type="password" id="password" name="passwordKey" class="form-control">
    </div>
    <div class="mt-3">
        <button type="submit" class="btn btn-primary">ログイン</button>
    </div>
</form>
```

* 変更しない場合
```java
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
            .mvcMatchers("/login**").permitAll()
            .anyRequest().authenticated()
            .and()
            .formLogin()
            .loginPage("/login");
    }
```

* nameの値が変わっていることに注目
```html
<h1>ログインページ</h1>
<form action="" th:action="@{/login}" method="post">
    <div class="mt-3">
        <label for="userName" class="form-label">ユーザー名</label>
        <input type="text" id="userName" name="username" class="form-control">
    </div>
    <div class="mt-3">
        <label for="password" class="form-label">パスワード</label>
        <input type="password" id="password" name="password" class="form-control">
    </div>
    <div class="mt-3">
        <button type="submit" class="btn btn-primary">ログイン</button>
    </div>
</form>
```

### ログインエラー処理の実装 と ログアウトの実装

ログインエラー時、Spring-boot-Security では、[ http://localhost:8080/login?error ]がURLに返ってきます。
この時、?から先がパラメータとして扱われます。詳しくは、以下を参照
[必読:MDN URLとは何か](https://developer.mozilla.org/ja/docs/Learn/Common_questions/What_is_a_URL)

このパラメーターを取得して、errorだった場合にボタンの下に表示アラートを出すようにします。
bootstrapのtext-dangerをクラス名で付けることで目立たせます。

```html
<div th:if="${param.error}">
    <p class="text-danger">ユーザー名もしくはパスワードが違います</p>
</div>  
```
paramはthymleafでリクエストパラメータを参照することができる機能を持っている。

